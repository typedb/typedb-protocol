//
// Copyright (C) 2022 Vaticle
//
// This program is free software: you can redistribute it and/or modify
// it under the terms of the GNU Affero General Public License as
// published by the Free Software Foundation, either version 3 of the
// License, or (at your option) any later version.
//
// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU Affero General Public License for more details.
//
// You should have received a copy of the GNU Affero General Public License
// along with this program.  If not, see <https://www.gnu.org/licenses/>.
//

syntax = "proto3";

option java_package = "com.vaticle.typedb.protocol";
option java_outer_classname = "ConceptProto";

package typedb.protocol;

message ConceptManager {

    message Req {
        oneof req {
            GetEntityType.Req get_entity_type_req = 1;
            GetRelationType.Req get_relation_type_req = 2;
            GetAttributeType.Req get_attribute_type_req = 3;
            GetEntity.Req get_entity_req = 4;
            GetRelation.Req get_relation_req = 5;
            GetAttribute.Req get_attribute_req = 6;
            PutEntityType.Req put_entity_type_req = 7;
            PutRelationType.Req put_relation_type_req = 8;
            PutAttributeType.Req put_attribute_type_req = 9;
            GetSchemaExceptions.Req get_schema_exceptions_req = 10;
        }
    }

    message Res {
        oneof res {
            GetEntityType.Res get_entity_type_res = 1;
            GetRelationType.Res get_relation_type_res = 2;
            GetAttributeType.Res get_attribute_type_res = 3;
            GetEntity.Res get_entity_res = 4;
            GetRelation.Res get_relation_res = 5;
            GetAttribute.Res get_attribute_res = 6;
            PutEntityType.Res put_entity_type_res = 7;
            PutRelationType.Res put_relation_type_res = 8;
            PutAttributeType.Res put_attribute_type_res = 9;
            GetSchemaExceptions.Res get_schema_exceptions_res = 10;
        }
    }

    message GetEntityType {
        message Req {
            string label = 1;
        }
        message Res {
            optional EntityType entity_type = 1;
        }
    }

    message GetRelationType {
        message Req {
            string label = 1;
        }
        message Res {
            optional RelationType relation_type = 1;
        }
    }

    message GetAttributeType {
        message Req {
            string label = 1;
        }
        message Res {
            optional AttributeType attribute_type = 1;
        }
    }

    message GetEntity {
        message Req {
            bytes iid = 1;
        }
        message Res {
            optional Entity entity = 1;
        }
    }

    message GetRelation {
        message Req {
            bytes iid = 1;
        }
        message Res {
            optional Relation relation = 1;
        }
    }

    message GetAttribute {
        message Req {
            bytes iid = 1;
        }
        message Res {
            optional Attribute attribute = 1;
        }
    }

    message PutEntityType {
        message Req {
            string label = 1;
        }
        message Res {
            EntityType entity_type = 1;
        }
    }

    message PutRelationType {
        message Req {
            string label = 1;
        }
        message Res {
            RelationType relation_type = 1;
        }
    }

    message PutAttributeType {
        message Req {
            string label = 1;
            AttributeType.ValueType value_type = 2;
        }
        message Res {
            AttributeType attribute_type = 1;
        }
    }

    message GetSchemaExceptions {
        message Req {}
        message Res {
            repeated Exception exceptions = 1;
        }
    }
}

message Exception {
    string code = 1;
    string message = 2;
}

message Concept {
    oneof concept {
        EntityType entity_type = 1;
        RelationType relation_type = 2;
        AttributeType attribute_type = 3;

        RoleType role_type = 4;

        Entity entity = 5;
        Relation relation = 6;
        Attribute attribute = 7;
    }

    enum Transitivity {
        TRANSITIVE = 0;
        EXPLICIT = 1;
    }

    enum OwnsFilter {
        ALL = 0;
        KEYS_ONLY = 1;
    }
}

message Thing {
    oneof thing {
        Entity entity = 1;
        Relation relation = 2;
        Attribute attribute = 3;
    }

    message Req {
        bytes iid = 1;
        oneof req {
            Thing.Delete.Req thing_delete_req = 100;
            Thing.GetHas.Req thing_get_has_req = 101;
            Thing.SetHas.Req thing_set_has_req = 102;
            Thing.UnsetHas.Req thing_unset_has_req = 103;
            Thing.GetRelations.Req thing_get_relations_req = 104;
            Thing.GetPlaying.Req thing_get_playing_req = 105;

            Entity.GetType.Req thing_get_type_req = 200;

            Relation.GetType.Req relation_get_type_req = 300;
            Relation.AddPlayer.Req relation_add_player_req = 301;
            Relation.RemovePlayer.Req relation_remove_player_req = 302;
            Relation.GetPlayers.Req relation_get_players_req = 303;
            Relation.GetPlayersByRoleType.Req relation_get_players_by_role_type_req = 304;
            Relation.GetRelating.Req relation_get_relating_req = 305;

            Attribute.GetType.Req attribute_get_type_req = 400;
            Attribute.GetOwners.Req attribute_get_owners_req = 401;
        }
    }

    message Res {
        oneof res {
            Thing.Delete.Res thing_delete_res = 100;
            Thing.SetHas.Res thing_set_has_res = 102;
            Thing.UnsetHas.Res thing_unset_has_res = 103;

            Entity.GetType.Req thing_get_type_req = 200;

            Relation.GetType.Req relation_get_type_req = 300;
            Relation.AddPlayer.Res relation_add_player_res = 301;
            Relation.RemovePlayer.Res relation_remove_player_res = 302;

            Attribute.GetType.Req attribute_get_type_req = 400;
        }
    }

    message ResPart {
        oneof res {
            Thing.GetHas.ResPart thing_get_has_res_part = 101;
            Thing.GetRelations.ResPart thing_get_relations_res_part = 104;
            Thing.GetPlaying.ResPart thing_get_playing_res_part = 105;

            Relation.GetPlayers.ResPart relation_get_players_res_part = 303;
            Relation.GetPlayersByRoleType.ResPart relation_get_players_by_role_type_res_part = 304;
            Relation.GetRelating.ResPart relation_get_relating_res_part = 305;

            Attribute.GetOwners.ResPart attribute_get_owners_res_part = 401;
        }
    }

    message Delete {
        message Req {}
        message Res {}
    }

    message SetHas {
        message Req {
            Attribute attribute = 1;
        }
        message Res {}
    }

    message UnsetHas {
        message Req {
            Attribute attribute = 1;
        }
        message Res {}
    }

    message GetHas {
        message Req {
            oneof filter {
                AttributeTypes attribute_types = 1;
                AnnotationFilter annotation_filter = 2;
            }
            // Only one filter can be set at a time. repeated can't be used in a oneof
            message AttributeTypes {
                repeated AttributeType attribute_types = 1;
            }
            message AnnotationFilter {
                repeated Type.Annotation annotations = 1;
            }
        }
        message ResPart {
            repeated Attribute attributes = 1;
        }
    }

    message GetPlaying {
        message Req {}
        message ResPart {
            repeated RoleType role_types = 1;
        }
    }

    message GetRelations {
        message Req {
            repeated RoleType role_types = 1;
        }
        message ResPart {
            repeated Relation relations = 1;
        }
    }
}

message Entity {
    bytes iid = 1;
    EntityType entity_type = 2;
    bool inferred = 3;

    message GetType {
        message Req {}
        message Res {
            EntityType entity_type = 1;
        }
    }

}

message Relation {
    bytes iid = 1;
    RelationType relation_type = 2;
    bool inferred = 3;

    message GetType {
        message Req {}
        message Res {
            RelationType relation_type = 1;
        }
    }

    message AddPlayer {
        message Req {
            RoleType role_type = 1;
            Thing player = 2;
        }
        message Res {}
    }

    message RemovePlayer {
        message Req {
            RoleType role_type = 1;
            Thing player = 2;
        }
        message Res {}
    }

    message GetPlayers {
        message Req {
            repeated RoleType role_types = 1;
        }
        message ResPart {
            repeated Thing things = 1;
        }
    }

    message GetPlayersByRoleType {
        message RoleTypeWithPlayer {
            RoleType role_type = 1;
            Thing player = 2;
        }
        message Req {}
        message ResPart {
            repeated RoleTypeWithPlayer role_types_with_players = 1;
        }
    }

    message GetRelating {
        message Req {}
        message ResPart {
            repeated RoleType role_types = 1;
        }
    }
}

message Attribute {
    bytes iid = 1;
    AttributeType attribute_type = 2;
    Value value = 3;
    bool inferred = 4;

    message GetType {
        message Req {}
        message Res {
            AttributeType attribute_type = 1;
        }
    }

    message Value {
        oneof value {
            string string = 1;
            bool boolean = 2;
            int64 long = 3;
            double double = 4;
            // time since epoch in milliseconds
            int64 date_time = 5;
        }
    }

    message GetOwners {
        message Req {
            optional ThingType filter = 1;
        }
        message ResPart {
            repeated Thing things = 1;
        }
    }
}

message Type {
    message Req {
        string label = 1;
        optional string scope = 2;
        oneof req {
            Type.Delete.Req type_delete_req = 100;
            Type.SetLabel.Req type_set_label_req = 101;

            RoleType.GetSupertype.Req role_type_get_supertype_req = 200;
            RoleType.SetSupertype.Req role_type_set_supertype_req = 201;
            RoleType.GetSupertypes.Req role_type_get_supertypes_req = 202;
            RoleType.GetSubtypes.Req role_type_get_subtypes_req = 203;
            RoleType.GetRelationTypes.Req role_type_get_relation_types_req = 204;
            RoleType.GetPlayerTypes.Req role_type_get_player_types_req = 205;
            RoleType.GetRelationInstances.Req role_type_get_relation_instances_req = 206;
            RoleType.GetPlayerInstances.Req role_type_get_player_instances_req = 207;

            ThingType.SetAbstract.Req thing_type_set_abstract_req = 300;
            ThingType.UnsetAbstract.Req thing_type_unset_abstract_req = 301;
            ThingType.GetOwns.Req thing_type_get_owns_req = 302;
            ThingType.GetOwnsOverridden.Req thing_type_get_owns_overridden_req = 303;
            ThingType.SetOwns.Req thing_type_set_owns_req = 304;
            ThingType.UnsetOwns.Req thing_type_unset_owns_req = 305;
            ThingType.GetPlays.Req thing_type_get_plays_req = 306;
            ThingType.GetPlaysOverridden.Req thing_type_get_plays_overridden_req = 307;
            ThingType.SetPlays.Req thing_type_set_plays_req = 308;
            ThingType.UnsetPlays.Req thing_type_unset_plays_req = 309;
            ThingType.GetSyntax.Req thing_type_get_syntax_req = 310;

            EntityType.Create.Req entity_type_create_req = 400;
            EntityType.GetSupertype.Req entity_type_get_supertype_req = 401;
            EntityType.SetSupertype.Req entity_type_set_supertype_req = 402;
            EntityType.GetSupertypes.Req entity_type_get_supertypes_req = 403;
            EntityType.GetSubtypes.Req entity_type_get_subtypes_req = 404;
            EntityType.GetInstances.Req entity_type_get_instances_req = 405;

            RelationType.Create.Req relation_type_create_req = 500;
            RelationType.GetSupertype.Req relation_type_get_supertype_req = 501;
            RelationType.SetSupertype.Req relation_type_set_supertype_req = 502;
            RelationType.GetSupertypes.Req relation_type_get_supertypes_req = 503;
            RelationType.GetSubtypes.Req relation_type_get_subtypes_req = 504;
            RelationType.GetInstances.Req relation_type_get_instances_req = 505;
            RelationType.GetRelates.Req relation_type_get_relates_req = 506;
            RelationType.GetRelatesForRoleLabel.Req relation_type_get_relates_for_role_label_req = 507;
            RelationType.GetRelatesOverridden.Req relation_type_get_relates_overridden_req = 508;
            RelationType.SetRelates.Req relation_type_set_relates_req = 509;
            RelationType.UnsetRelates.Req relation_type_unset_relates_req = 510;

            AttributeType.Put.Req attribute_type_put_req = 600;
            AttributeType.Get.Req attribute_type_get_req = 601;
            AttributeType.GetSupertype.Req attribute_type_get_supertype_req = 602;
            AttributeType.SetSupertype.Req attribute_type_set_supertype_req = 603;
            AttributeType.GetSupertypes.Req attribute_type_get_supertypes_req = 604;
            AttributeType.GetSubtypes.Req attribute_type_get_subtypes_req = 605;
            AttributeType.GetInstances.Req attribute_type_get_instances_req = 606;
            AttributeType.GetRegex.Req attribute_type_get_regex_req = 607;
            AttributeType.SetRegex.Req attribute_type_set_regex_req = 608;
            AttributeType.GetOwners.Req attribute_type_get_owners_req = 609;
        }
    }

    message Res {
        oneof res {
            Type.Delete.Res type_delete_req = 100;
            Type.SetLabel.Res type_set_label_req = 101;

            RoleType.GetSupertype.Res role_type_get_supertype_req = 200;
            RoleType.SetSupertype.Res role_type_set_supertype_req = 201;

            ThingType.SetAbstract.Res thing_type_set_abstract_req = 300;
            ThingType.UnsetAbstract.Res thing_type_unset_abstract_req = 301;
            ThingType.GetOwnsOverridden.Res thing_type_get_owns_overridden_req = 303;
            ThingType.SetOwns.Res thing_type_set_owns_req = 304;
            ThingType.UnsetOwns.Res thing_type_unset_owns_req = 305;
            ThingType.GetPlaysOverridden.Res thing_type_get_plays_overridden_req = 307;
            ThingType.SetPlays.Res thing_type_set_plays_req = 308;
            ThingType.UnsetPlays.Res thing_type_unset_plays_req = 309;
            ThingType.GetSyntax.Res thing_type_get_syntax_req = 310;

            EntityType.Create.Res entity_type_create_req = 400;
            EntityType.GetSupertype.Res entity_type_get_supertype_req = 401;
            EntityType.SetSupertype.Res entity_type_set_supertype_req = 402;

            RelationType.Create.Res relation_type_create_req = 500;
            RelationType.GetSupertype.Res relation_type_get_supertype_req = 501;
            RelationType.SetSupertype.Res relation_type_set_supertype_req = 502;
            RelationType.GetRelatesForRoleLabel.Res relation_type_get_relates_for_role_label_req = 507;
            RelationType.GetRelatesOverridden.Res relation_type_get_relates_overridden_req = 508;
            RelationType.SetRelates.Res relation_type_set_relates_req = 509;
            RelationType.UnsetRelates.Res relation_type_unset_relates_req = 510;

            AttributeType.Put.Res attribute_type_put_req = 600;
            AttributeType.Get.Res attribute_type_get_req = 601;
            AttributeType.GetSupertype.Res attribute_type_get_supertype_req = 602;
            AttributeType.SetSupertype.Res attribute_type_set_supertype_req = 603;
            AttributeType.GetRegex.Res attribute_type_get_regex_req = 607;
            AttributeType.SetRegex.Res attribute_type_set_regex_req = 608;
        }
    }

    message ResPart {
        oneof res {
            RoleType.GetSupertypes.ResPart role_type_get_supertypes_req = 202;
            RoleType.GetSubtypes.ResPart role_type_get_subtypes_req = 203;
            RoleType.GetRelationTypes.ResPart role_type_get_relation_types_req = 204;
            RoleType.GetPlayerTypes.ResPart role_type_get_player_types_req = 205;
            RoleType.GetRelationInstances.ResPart role_type_get_relation_instances_req = 206;
            RoleType.GetPlayerInstances.ResPart role_type_get_player_instances_req = 207;

            ThingType.GetOwns.ResPart thing_type_get_owns_req = 302;
            ThingType.GetPlays.ResPart thing_type_get_plays_req = 306;

            EntityType.GetSupertypes.ResPart entity_type_get_supertypes_req = 403;
            EntityType.GetSubtypes.ResPart entity_type_get_subtypes_req = 404;
            EntityType.GetInstances.ResPart entity_type_get_instances_req = 405;

            RelationType.GetSupertypes.ResPart relation_type_get_supertypes_req = 503;
            RelationType.GetSubtypes.ResPart relation_type_get_subtypes_req = 504;
            RelationType.GetInstances.ResPart relation_type_get_instances_req = 505;
            RelationType.GetRelates.ResPart relation_type_get_relates_req = 506;

            AttributeType.GetSupertypes.ResPart attribute_type_get_supertypes_req = 604;
            AttributeType.GetSubtypes.ResPart attribute_type_get_subtypes_req = 605;
            AttributeType.GetInstances.ResPart attribute_type_get_instances_req = 606;
            AttributeType.GetOwners.ResPart attribute_type_get_owners_req = 609;
        }
    }

    message Annotation {
        oneof annotation {
            Key key = 1;
            Unique unique = 2;
        }

        message Key {}
        message Unique {}
    }

    message Delete {
        message Req {}
        message Res {}
    }

    message SetLabel {
        message Req {
            string label = 1;
        }
        message Res {}
    }
}

message RoleType {
    string label = 1;
    string scope = 2;
    bool is_root = 3;

    message GetSupertype {
        message Req {}
        message Res {
            RoleType role_type = 1;
        }
    }

    message SetSupertype {
        message Req {
            RoleType role_type = 1;
        }
        message Res {}
    }

    message GetSupertypes {
        message Req {}
        message ResPart {
            repeated RoleType role_type = 1;
        }
    }

    message GetSubtypes {
        message Req {}
        message ResPart {
            repeated RoleType role_type = 1;
        }
    }

    message GetRelationTypes {
        message Req {}
        message ResPart {
            repeated RelationType relation_types = 1;
        }
    }

    message GetPlayerTypes {
        message Req {
            Concept.Transitivity transitivity = 1;
        }
        message ResPart {
            repeated ThingType thing_types = 1;
        }
    }

    message GetRelationInstances {
        message Req {
            Concept.Transitivity transitivity = 1;
        }
        message ResPart {
            repeated Relation relations = 1;
        }
    }

    message GetPlayerInstances {
        message Req {
            Concept.Transitivity transitivity = 1;
        }
        message ResPart {
            repeated Thing things = 1;
        }
    }
}

message ThingType {
    oneof type {
        EntityType entity_type = 1;
        RelationType relation_type = 2;
        AttributeType attribute_type = 3;
    }

    message SetAbstract {
        message Req {}
        message Res {}
    }

    message UnsetAbstract {
        message Req {}
        message Res {}
    }

    message GetOwns {
        message Req {
            optional AttributeType.ValueType filter = 1;
            Concept.Transitivity transitivity = 2;
            repeated Type.Annotation annotations = 3;
        }
        message ResPart {
            repeated AttributeType attribute_types = 1;
        }
    }

    message GetOwnsOverridden {
        message Req {
            AttributeType attribute_type = 1;
        }
        message Res {
            optional AttributeType attribute_type = 1;
        }
    }

    message SetOwns {
        message Req {
            AttributeType attribute_type = 1;
            optional AttributeType overridden_type = 2;
            repeated Type.Annotation annotations = 3;
        }
        message Res {}
    }

    message UnsetOwns {
        message Req {
            AttributeType attribute_type = 1;
        }
        message Res {}
    }

    message GetPlays {
        message Req {
            optional Concept.Transitivity transitivity = 1;
        }
        message ResPart {
            repeated RoleType role_types = 1;
        }
    }

    message GetPlaysOverridden {
        message Req {
            RoleType role_type = 2;
        }
        message Res {
            optional RoleType role_type = 1;
        }
    }

    message SetPlays {
        message Req {
            RoleType role_type = 1;
            optional RoleType overridden_role_type = 2;
        }
        message Res {}
    }

    message UnsetPlays {
        message Req {
            RoleType role_type = 1;
        }
        message Res {}
    }

    message GetSyntax {
        message Req {}
        message Res {
            string syntax = 1;
        }
    }
}

message EntityType {
    string label = 1;
    bool is_root = 2;
    bool is_abstract = 3;

    message Create {
        message Req {}
        message Res {
            Entity entity = 1;
        }
    }

    message GetSupertype {
        message Req {}
        message Res {
            EntityType entity_type = 1;
        }
    }

    message SetSupertype {
        message Req {
            EntityType entity_type = 1;
        }
        message Res {}
    }

    message GetSupertypes {
        message Req {}
        message ResPart {
            repeated EntityType entity_type = 1;
        }
    }

    message GetSubtypes {
        message Req {}
        message ResPart {
            repeated EntityType entity_type = 1;
        }
    }

    message GetInstances {
        message Req {
            Concept.Transitivity transitivity = 1;
        }
        message ResPart {
            repeated Entity entities = 1;
        }
    }
}

message RelationType {
    string label = 1;
    bool is_root = 2;
    bool is_abstract = 3;

    message Create {
        message Req {}
        message Res {
            Relation relation = 1;
        }
    }

    message GetSupertype {
        message Req {}
        message Res {
            RelationType relation_type = 1;
        }
    }

    message SetSupertype {
        message Req {
            RelationType relation_type = 1;
        }
        message Res {}
    }

    message GetSupertypes {
        message Req {}
        message ResPart {
            repeated RelationType relation_type = 1;
        }
    }

    message GetSubtypes {
        message Req {}
        message ResPart {
            repeated RelationType relation_type = 1;
        }
    }

    message GetInstances {
        message Req {
            Concept.Transitivity transitivity = 1;
        }
        message ResPart {
            repeated Relation entities = 1;
        }
    }

    message GetRelates {
        message Req {
            Concept.Transitivity transitivity = 1;
        }
        message ResPart {
            repeated RoleType role_types = 1;
        }
    }

    message GetRelatesForRoleLabel {
        message Req {
            string label = 1;
        }
        message Res {
            optional RoleType role_type = 1;
        }
    }

    message GetRelatesOverridden {
        message Req {
            string label = 1;
        }
        message Res {
            optional RoleType role_type = 1;
        }
    }

    message SetRelates {
        message Req {
            string label = 1;
            optional string overridden_label = 2;
        }
        message Res {}
    }

    message UnsetRelates {
        message Req {
            string label = 1;
        }
        message Res {}
    }
}

message AttributeType {
    string label = 1;
    ValueType value_type = 2;
    bool is_root = 3;
    bool is_abstract = 4;

    enum ValueType {
        OBJECT = 0;
        BOOLEAN = 1;
        LONG = 2;
        DOUBLE = 3;
        STRING = 4;
        DATETIME = 5;
    }

    message Put {
        message Req {
            Attribute.Value value = 1;
        }
        message Res {
            Attribute attribute = 1;
        }
    }

    message Get {
        message Req {
            Attribute.Value value = 1;
        }
        message Res {
            optional Attribute attribute = 1;
        }
    }

    message GetSupertype {
        message Req {}
        message Res {
            AttributeType attribute_type = 1;
        }
    }

    message SetSupertype {
        message Req {
            AttributeType attribute_type = 1;
        }
        message Res {}
    }

    message GetSupertypes {
        message Req {}
        message ResPart {
            repeated AttributeType attribute_type = 1;
        }
    }

    message GetSubtypes {
        message Req {
            optional ValueType value_type = 1;
        }
        message ResPart {
            repeated AttributeType attribute_type = 1;
        }
    }

    message GetInstances {
        message Req {
            Concept.Transitivity transitivity = 1;
            optional ValueType value_type = 2;
        }
        message ResPart {
            repeated Attribute entities = 1;
        }
    }

    message GetOwners {
        message Req {
            Concept.Transitivity transitivity = 1;
            repeated Type.Annotation annotations = 2;
        }
        message ResPart {
            repeated ThingType thing_types = 1;
        }
    }

    message GetRegex {
        message Req {}
        message Res {
            string regex = 1;
        }
    }

    message SetRegex {
        message Req {
            string regex = 1;
        }
        message Res {}
    }
}
